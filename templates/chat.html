<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: sans-serif; margin: 0; background: #084d6e; height: 100vh; display: flex; flex-direction: column; }
        #chat-screen { flex: 1; display: flex; flex-direction: column; }
        .header { padding: 15px; background: #084d6e; display: flex; justify-content: space-between; align-items: center; color: white; }
        .logout-btn { color: #ff4d4d; cursor: pointer; font-weight: bold; border: 1px solid #ff4d4d; padding: 5px 10px; border-radius: 5px; }
        
        #msg-container { flex: 1; overflow-y: auto; padding: 15px; background: #084d6e; }
        .input-area { background: white; padding: 10px; display: flex; align-items: center; gap: 10px; }
        input { flex: 1; border: none; outline: none; padding: 10px; font-size: 16px; }

        #settings-screen { display: none; background: white; height: 100%; padding: 20px; text-align: center; position: absolute; width: 100%; box-sizing: border-box; }
        .profile-img-container { position: relative; width: 120px; height: 120px; margin: 0 auto 20px; }
        #profile-pic { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid #34aadc; cursor: pointer; }
    </style>
</head>
<body>
    <div id="chat-screen">
        <div class="header">
            <span>Rathana Chat</span>
            <div class="logout-btn" onclick="logout()">Log Out</div> </div>
        <div id="msg-container"></div>
        <div class="input-area">
            <input type="text" id="msg-input" placeholder="Message">
            <span onclick="addEmoji()" style="cursor:pointer; font-size:24px;">ðŸ˜Š</span>
            <i class="fa-solid fa-microphone-lines" id="mic" style="font-size:24px; color:#888;" onclick="startVoice()"></i>
            <i class="fa-solid fa-paper-plane" onclick="send()" style="font-size:24px; color:#34aadc;"></i>
        </div>
    </div>

    <div id="settings-screen">
        <h2>Settings</h2>
        <div class="profile-img-container" onclick="document.getElementById('file-input').click()">
            <img id="profile-pic" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
            <input type="file" id="file-input" hidden accept="image/*" onchange="uploadPhoto(event)">
        </div>
        <input type="text" id="name-in" placeholder="Name" style="width:90%; border:1px solid #ddd; margin-bottom:10px; border-radius:5px;">
        <input type="text" id="user-in" placeholder="@username" style="width:90%; border:1px solid #ddd; margin-bottom:20px; border-radius:5px;">
        <button onclick="saveProfile()" style="width:95%; padding:12px; background:#34aadc; color:white; border:none; border-radius:8px;">Save Changes</button>
        <p onclick="toggleSettings(false)" style="color:red; cursor:pointer; margin-top:20px;">Back to Chat</p>
    </div>

    <div style="height:60px; background:white; display:flex; border-top:1px solid #ddd;">
        <div style="flex:1; text-align:center; padding-top:10px;" onclick="toggleSettings(false)"><i class="fa-solid fa-comment"></i><br>Chats</div>
        <div style="flex:1; text-align:center; padding-top:10px;" onclick="toggleSettings(true)"><i class="fa-solid fa-gear"></i><br>Settings</div>
    </div>

    <script>
        const socket = io();
        let myData = JSON.parse(localStorage.getItem('profile')) || {name:'User', photo:''};

        function toggleSettings(show) { document.getElementById('settings-screen').style.display = show ? 'block' : 'none'; }
        
        function uploadPhoto(event) {
            const reader = new FileReader();
            reader.onload = function() {
                document.getElementById('profile-pic').src = reader.result;
                myData.photo = reader.result;
            }
            reader.readAsDataURL(event.target.files[0]);
        }

        function saveProfile() {
            myData.name = document.getElementById('name-in').value;
            localStorage.setItem('profile', JSON.stringify(myData));
            fetch('/save_profile', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(myData) });
            alert("ážšáž€áŸ’ážŸáž¶áž‘áž»áž€áž”áž¶áž“áž‡áŸ„áž‚áž‡áŸáž™!");
            toggleSettings(false);
        }

        function logout() { localStorage.clear(); location.reload(); }
        function addEmoji() { document.getElementById('msg-input').value += "ðŸ˜Š"; }
        function startVoice() { 
            document.getElementById('mic').style.color = 'red';
            setTimeout(() => { 
                document.getElementById('mic').style.color = '#888';
                alert("ážŸáž¶ážšážŸáŸ†áž¡áŸáž„ážáŸ’ážšáž¼ážœáž”áž¶áž“áž•áŸ’áž‰áž¾!"); 
            }, 2000);
        }

        function send() {
            const val = document.getElementById('msg-input').value;
            if(val) {
                socket.emit('message', {name: myData.name, msg: val, time: new Date().toLocaleTimeString()});
                document.getElementById('msg-input').value = '';
            }
        }

        socket.on('message', d => {
            const div = document.createElement('div');
            div.style = "background:white; margin:10px; padding:10px; border-radius:10px; width:fit-content;";
            div.innerHTML = `<b>${d.name}:</b> ${d.msg}`;
            document.getElementById('msg-container').appendChild(div);
        });
    </script>
</body>
</html>
