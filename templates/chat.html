<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ášá€áŸ’áŸá¶ Style áŠá¾á˜ášá”áŸáŸ‹á¢áŸ’á“á€á‘á¶áŸ†á„á¢áŸáŸ‹ */
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; background: #084d6e; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #app-container { flex: 1; display: flex; flex-direction: column; position: relative; }
        .header-search { padding: 12px; background: #084d6e; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .search-input { width: 100%; padding: 10px 15px; border-radius: 12px; border: none; background: #063d57; color: white; outline: none; box-sizing: border-box; }
        #msg-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; background: #084d6e; }
        .msg-wrapper { display: flex; align-items: flex-end; margin: 8px 0; max-width: 85%; }
        .wrapper-sent { align-self: flex-end; flex-direction: row-reverse; }
        .wrapper-received { align-self: flex-start; }
        .mini-pic { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin: 0 8px; background: #ccc; }
        .msg { padding: 10px 14px; border-radius: 18px; font-size: 15px; position: relative; }
        .sent { background: #effdde; color: black; border-bottom-right-radius: 4px; }
        .received { background: white; color: black; border-bottom-left-radius: 4px; }
        .status { font-size: 10px; opacity: 0.6; display: flex; align-items: center; justify-content: flex-end; margin-top: 4px; gap: 3px; }
        .tick { color: #34aadc; font-size: 12px; }
        .input-area { background: white; padding: 10px 15px; display: flex; align-items: center; gap: 12px; }
        #msg-input { flex: 1; border: none; outline: none; padding: 10px; background: #f1f1f1; border-radius: 20px; font-size: 16px; }
        .input-icons { display: flex; gap: 18px; color: #8e8e8e; font-size: 24px; }
        .recording { color: #ff4d4d !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #settings-view { display: none; position: absolute; inset: 0; background: white; z-index: 100; padding: 25px; text-align: center; }
        #set-img { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #34aadc; margin: 20px auto; display: block; }
        .logout-btn { color: #ff4d4d; border: 1px solid #ff4d4d; padding: 10px 25px; border-radius: 25px; cursor: pointer; display: inline-block; margin-top: 30px; font-weight: bold; }
        .nav-bar { height: 65px; background: white; display: flex; border-top: 1px solid #eee; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #8e8e8e; cursor: pointer; font-size: 11px; }
        .nav-item.active { color: #34aadc; }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="chat-view" style="display: flex; flex-direction: column; height: 100%;">
            <div class="header-search"><input type="text" class="search-input" placeholder="áŸáŸ’áœáŸ‚á„ášá€áŸá¶áš..."></div>
            <div id="msg-container"></div>
            <div class="input-area">
                <span onclick="addEmoji()" style="cursor:pointer; font-size: 24px;">ğŸ˜Š</span>
                <input type="text" id="msg-input" placeholder="áŸášáŸáŸášáŸá¶áš...">
                <div class="input-icons">
                    <i class="fa-solid fa-microphone" id="mic-icon" onclick="toggleVoice()" style="cursor:pointer"></i>
                    <i class="fa-solid fa-image" onclick="document.getElementById('image-in').click()" style="cursor:pointer"></i>
                    <input type="file" id="image-in" hidden accept="image/*" onchange="sendImg(event)">
                    <i class="fa-solid fa-paper-plane" onclick="sendMsg()" style="color:#34aadc; cursor:pointer"></i>
                </div>
            </div>
        </div>

        <div id="settings-view">
            <h2>á€á¶ášá€áŸ†áááŸ‹ Profile</h2>
            <img id="set-img" src="{{ photo }}" alt="Profile">
            <p>áˆáŸ’á˜áŸ„áŸ‡á¢áŸ’á“á€á”áŸ’ášá¾áŸ– <b>{{ name }}</b> (@{{ username }})</p>
            <div class="logout-btn" onclick="window.location.href='/logout'">á…á¶á€á…áŸá‰á–á¸á‚áá“á¸ (Logout)</div>
            <p onclick="showTab('chat')" style="color:#34aadc; cursor:pointer; margin-top:20px;">ááŸ’ášá¡á”áŸ‹á‘áŸ…á•áŸ’á‘á¶áŸ†á„á†á¶ááœá·á‰</p>
        </div>

        <div class="nav-bar">
            <div class="nav-item active" id="chat-tab" onclick="showTab('chat')">
                <i class="fa-regular fa-comment" style="font-size:24px;"></i>á†á¶á
            </div>
            <div class="nav-item" id="set-tab" onclick="showTab('settings')">
                <i class="fa-solid fa-gear" style="font-size:24px;"></i>á€áŸ†áááŸ‹
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let mediaRecorder, audioChunks = [], isRecording = false;
        let currentRoom = "main_room"; // á”á“áŸ’á‘á”áŸ‹ášá½á˜

        // á‘á¶á‰á™á€á–áŸááŸŒá˜á¶á“á–á¸ Server Session áŠáŸ‚á›á”á¶á“ Login
        const userProfile = {
            name: "{{ name }}",
            username: "{{ username }}",
            photo: "{{ photo }}"
        };

        // á…á¼á›á‘áŸ…á€á¶á“áŸ‹ Room áŠá¾á˜áŸ’á”á¸á‘á¶á‰á™á€á”áŸ’ášáœááŸ’áá·áŸá¶ášá…á¶áŸáŸ‹áŸ—
        socket.emit('join', { room: currentRoom });

        // á˜á»áá„á¶ášá”áŸ’áá¼áš Tab (Chat / Settings)
        function showTab(t) {
            document.getElementById('chat-view').style.display = t === 'chat' ? 'flex' : 'none';
            document.getElementById('settings-view').style.display = t === 'settings' ? 'block' : 'none';
            document.getElementById('chat-tab').classList.toggle('active', t === 'chat');
            document.getElementById('set-tab').classList.toggle('active', t === 'settings');
        }

        // á˜á»áá„á¶áš Emoji
        function addEmoji() { 
            document.getElementById('msg-input').value += "ğŸ˜Š"; 
            document.getElementById('msg-input').focus();
        }

        // á˜á»áá„á¶ášá•áŸ’á‰á¾áŸá¶ášá¢á€áŸ’áŸáš
        function sendMsg() {
            const inp = document.getElementById('msg-input');
            if(inp.value.trim()) {
                const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                socket.emit('message', { 
                    room: currentRoom, 
                    name: userProfile.name, 
                    msg: inp.value, 
                    time: time, 
                    photo: userProfile.photo 
                });
                inp.value = '';
            }
        }

        // á˜á»áá„á¶ášá•áŸ’á‰á¾ášá¼á”á—á¶á–
        function sendImg(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                const imgHtml = `<img src="${reader.result}" style="max-width:220px; border-radius:12px; display:block; margin-top:5px;">`;
                socket.emit('message', { 
                    room: currentRoom, 
                    name: userProfile.name, 
                    msg: imgHtml, 
                    time: time, 
                    photo: userProfile.photo 
                });
            };
            reader.readAsDataURL(file);
        }

        // á˜á»áá„á¶ášá•áŸ’á‰á¾áŸáŸ†á¡áŸá„
        async function toggleVoice() {
            const micIcon = document.getElementById('mic-icon');
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                        const reader = new FileReader();
                        reader.onload = () => {
                            const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                            const audioHtml = `<audio controls src="${reader.result}" style="width:200px; height:40px;"></audio>`;
                            socket.emit('message', { 
                                room: currentRoom, 
                                name: userProfile.name, 
                                msg: audioHtml, 
                                time: time, 
                                photo: userProfile.photo 
                            });
                        };
                        reader.readAsDataURL(audioBlob);
                        audioChunks = [];
                    };
                    mediaRecorder.start();
                    isRecording = true;
                    micIcon.classList.add('recording');
                } catch(e) {
                    alert("áŸá¼á˜á¢á“á»á‰áŸ’á‰á¶áá±áŸ’á™á”áŸ’ášá¾ Microphone á‡á¶á˜á»á“áŸá·á“!");
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                micIcon.classList.remove('recording');
            }
        }

        // á‘á‘á½á›áŸá¶ášá–á¸ Server (á‘á¶áŸ†á„áŸá¶ášááŸ’á˜á¸ á“á·á„á”áŸ’ášáœááŸ’áá·áŸá¶ášá…á¶áŸáŸ‹)
        socket.on('message', d => {
            const container = document.getElementById('msg-container');
            const isMe = d.name === userProfile.name;
            
            const wrap = document.createElement('div');
            wrap.className = `msg-wrapper ${isMe ? 'wrapper-sent' : 'wrapper-received'}`;
            
            const pic = document.createElement('img');
            pic.className = 'mini-pic';
            pic.src = d.photo || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
            
            const mDiv = document.createElement('div');
            mDiv.className = `msg ${isMe ? 'sent' : 'received'}`;
            
            const status = isMe ? 
                `<div class="status">${d.time} <i class="fa-solid fa-check-double tick"></i></div>` : 
                `<div class="status">${d.time}</div>`;
            
            mDiv.innerHTML = `${isMe ? '' : '<b>'+d.name+'</b><br>'}${d.msg}${status}`;
            
            wrap.appendChild(pic);
            wrap.appendChild(mDiv);
            container.appendChild(wrap);
            
            // ášá˜áŸ€á›á‘áŸ…á€áŸ’ášáŸ„á˜á”áŸ†á•á»áášá¶á›áŸ‹á–áŸá›á˜á¶á“áŸá¶ášááŸ’á˜á¸
            container.scrollTop = container.scrollHeight;
        });

        // á¢á“á»á‰áŸ’á‰á¶áá±áŸ’á™á•áŸ’á‰á¾áŸá¶ášáŠáŸ„á™á…á»á… Enter
        document.getElementById('msg-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMsg();
            }
        });
    </script>
</body>
</html>
