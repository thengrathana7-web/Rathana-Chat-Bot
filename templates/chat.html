<script>
    // --- ១. ប្រកាស Variables សំខាន់ៗ ---
    const msgBox = document.getElementById('msgBox');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.querySelector('.send-btn');
    const userSearch = document.getElementById('userSearch'); // ឬ searchInput
    const searchResult = document.getElementById('searchResult'); // ឬ resultBox

    // បង្កើត Variable សកលដើម្បីទុក ID អ្នកទទួល
    const urlParams = new URLSearchParams(window.location.search);
    window.currentReceiverId = urlParams.get('uid') || null;

    // --- ២. មុខងារស្វែងរកមិត្តភក្តិ (បូកបញ្ចូលគ្នា) ---
    userSearch.addEventListener('input', function() {
        // លុប @ ចេញ និងលុបចន្លោះទំនេរ (យកតាមកូដថ្មីរបស់អ្នក)
        let query = this.value.trim().replace('@', '');
        
        if (query.length > 2) {
            let formData = new FormData();
            formData.append('username', query);

            fetch('/search_friend', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                searchResult.style.display = 'block';
                if (data.status === "found") {
                    document.getElementById('resultInfo').style.display = 'flex';
                    document.getElementById('noResult').style.display = 'none';
                    document.getElementById('resName').innerText = data.name;
                    document.getElementById('resUser').innerText = '@' + data.username;
                    document.getElementById('resAvatar').innerText = data.name[0].toUpperCase();
                    
                    // ពេលចុចប៊ូតុង "ជជែក"
                    document.getElementById('addContactBtn').onclick = () => {
                        window.currentReceiverId = data.id; 
                        
                        // ប្តូរឈ្មោះនៅលើ Header
                        const chatTitle = document.getElementById('chatWithTitle') || document.querySelector('.header-left div[style*="font-size: 14px"]');
                        if (chatTitle) chatTitle.innerText = data.name;
                        
                        // កែប្រែ URL ដោយមិនចាំបាច់ Reload ទំព័រ
                        window.history.pushState({}, '', `/chat?uid=${data.id}`);
                        
                        // លាងសារចាស់ចេញពី msgBox (តាមកូដថ្មី)
                        msgBox.innerHTML = ""; 

                        // បិទប្រអប់ Search
                        searchResult.style.display = 'none';
                        userSearch.value = "";

                        // Reload ដើម្បីឱ្យ server ទាញសារបុគ្គលមក (រក្សាមុខងារកូដចាស់ដែលអ្នកត្រូវការ)
                        location.reload(); 
                    };
                } else {
                    document.getElementById('resultInfo').style.display = 'none';
                    document.getElementById('noResult').style.display = 'block';
                }
            })
            .catch(err => console.error("Error searching:", err));
        } else {
            searchResult.style.display = 'none';
        }
    });

    // ចុចខាងក្រៅដើម្បីបិទប្រអប់លទ្ធផល
    document.addEventListener('click', (e) => {
        if (!userSearch.contains(e.target) && !searchResult.contains(e.target)) {
            searchResult.style.display = 'none';
        }
    });

    // --- ៣. មុខងារផ្ញើសារ (One-by-One) ---
    function sendMessage() {
        const text = msgInput.value.trim();
        
        if (text === "") return;
        if (!window.currentReceiverId) {
            alert("សូមស្វែងរក និងជ្រើសរើសមិត្តភក្តិដើម្បីជជែកជាមុនសិន!");
            return;
        }

        fetch('/send_message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                message: text,
                receiver_id: window.currentReceiverId 
            })
        }).then(res => {
            if (res.ok) {
                const msgDiv = document.createElement('div');
                msgDiv.style = "background: #2b5278; padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; align-self: flex-end; max-width: 75%; color: white; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.2);";
                msgDiv.innerHTML = text + `<div style="font-size: 10px; color: #a0acba; text-align: right; margin-top: 4px;">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>`;
                
                msgBox.appendChild(msgDiv);
                msgInput.value = "";
                msgBox.scrollTop = msgBox.scrollHeight;
            }
        });
    }

    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

    // រុញ scroll ទៅក្រោមបំផុត
    msgBox.scrollTop = msgBox.scrollHeight;
</script>
